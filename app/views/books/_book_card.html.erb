<div class="book-list">
   <div class="book-item">
      <!-- Book Title Toggle Button -->
      <button class="book-title-btn" onclick="toggleDetails('<%= section_prefix %>-<%= book.id %>')">
         <%= link_to book.title, book_path(book), class: "book-title-link" %> ‚ñº

         <%= button_to toggle_favorite_book_path(book), method: :patch, class: "favorite-button" do %>
            <%= book.favorite ? "‚òÖ" : "‚òÜ" %>
         <% end %>
      </button>

      <!-- Book Details Section -->
      <div id="<%= section_prefix %>-<%= book.id %>" class="book-details">

         <!-- Basic Info -->
         <p><strong>Author:</strong> <%= book.author %></p>
         <p><strong>Genre:</strong> <%= book.genre %></p>

         <!-- Status & Progress -->
         <p>
            <strong>Status:</strong>
            <% if book.read? %>
               Finished
            <% elsif book.currently_reading? %>
               Currently Reading
            <% else %>
               Not Started
            <% end %>
         </p>

         <!-- Reading Status Toggle Buttons -->
         <% if book.read? %>
            <%= form_with(model: book, url: book_path(book), method: :patch, class: "read-toggle") do |form| %>
               <%= form.hidden_field :read, value: false %>
               <%= form.hidden_field :currently_reading, value: true %>
               <%= form.submit "Mark as Currently Reading", class: "button" %>
            <% end %>
         <% elsif book.currently_reading? %>
            <%= form_with(model: book, url: book_path(book), method: :patch, class: "read-toggle") do |form| %>
               <%= form.hidden_field :read, value: true %>
               <%= form.hidden_field :currently_reading, value: false %>
               <%= form.submit "Mark as Complete", class: "button" %>
            <% end %>

            <p><strong>Progress:</strong> <%= "#{book.page_number} / #{book.total_pages} Pages" %></p>
            <div class="progress-bar">
               <div class="progress" style="width: <%= book.progress_percentage %>%"></div>
            </div>
            <span class="progress-text"><%= "#{book.progress_percentage}%" %></span>
         <% else %>
            <%= form_with(model: book, url: book_path(book), method: :patch, class: "read-toggle") do |form| %>
               <%= form.hidden_field :currently_reading, value: true %>
               <%= form.hidden_field :read, value: false %>
               <%= form.submit "Start Reading", class: "button" %>
            <% end %>
         <% end %>

         <% unless !book.read? && !book.currently_reading? %>
            <%= form_with(model: book, url: book_path(book), method: :patch, class: "read-toggle") do |form| %>
               <%= form.hidden_field :read, value: false %>
               <%= form.hidden_field :currently_reading, value: false %>
               <%= form.submit "Mark as Not Started", class: "button" %>
            <% end %>
         <% end %>

         <!-- Wishlist -->
         <% if current_user.wishlist_books.include?(book) %>
            <%= button_to "Remove from Wishlist", remove_from_wishlist_book_path(book), method: :delete, class: "button" %>
         <% else %>
            <%= button_to "Add to Wishlist", add_to_wishlist_book_path(book), method: :post, class: "button" %>
         <% end %>

         <!-- Rating -->
         <p>
            <strong>Rating:</strong>
            <%= book.read? ? "#{book.rating} stars" : "Finish the book to add rating" %>
         </p>

         <!-- Notes Section -->
         <h3>üìù Book Notes</h3>
         <% if book.notes.any? %>
            <ul id="notes-list-<%= book.id %>">
               <%= render partial: "notes/note", collection: book.notes, as: :note %>
            </ul>
         <% else %>
            <p>No notes available for this book.</p>
         <% end %>

         <!-- Add Note Form -->
         <div id="new_note_form_<%= book.id %>">
            <%= form_with(model: [book, book.notes.build]) do |form| %>
               <div>
                  <%= form.label :content, "Add a Note?" %><br>
                  <%= form.text_area :content, rows: 3 %>
               </div>
               <%= form.submit "Add Note", class: "button" %>
            <% end %>
         </div>

         <!-- Book Actions -->
         <div class="book-actions">
            <%= link_to "Edit", edit_book_path(book), class: "button" %>
            <%= link_to "Show", book_path(book), class: "button" %>
            <%= form_with(model: book, method: :delete) do |form| %>
               <%= form.submit "Destroy", data: { confirm: "Are you sure you want to delete this book?" }, class: "button delete-button" %>
            <% end %>
         </div>

         

      </div>
   </div>
</div>

<script>
   function toggleDetails(bookId) {
      const details = document.getElementById(bookId);
      if (details.classList.contains("active")) {
         details.style.maxHeight = details.scrollHeight + "px";
         void details.offsetHeight;
         details.style.maxHeight = "0px";
         details.classList.remove("active");
         details.addEventListener("transitionend", () => {
            details.style.visibility = "hidden";
            details.style.padding = "0 10px";
         }, { once: true });
      } else {
         details.classList.add("active");
         details.style.visibility = "visible";
         details.style.padding = "10px";
         requestAnimationFrame(() => {
            details.style.maxHeight = details.scrollHeight + "px";
         });
      }
   }

   // Close book card when clicking outside
   document.addEventListener('click', function(event) {
   // Get all active book-details elements
   const openCards = document.querySelectorAll('.book-details.active');

   openCards.forEach(card => {
      // If click is outside the card AND not on a toggle button
      if (!card.contains(event.target) && !event.target.classList.contains('book-title-btn')) {
         card.style.maxHeight = card.scrollHeight + "px"; // needed to trigger transition
         void card.offsetHeight;
         card.style.maxHeight = "0px";
         card.classList.remove("active");
         card.addEventListener("transitionend", () => {
            card.style.visibility = "hidden";
            card.style.padding = "0 10px";
         }, { once: true });
      }
   });
});
</script>